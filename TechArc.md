# EC-MBR AI 무인 자동화 시스템 기술 아키텍처 제안

## 1. 전체 시스템 개요

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        EC-MBR AI 자동운전 플랫폼                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐  │
│  │   Sensing   │───▶│  Analytics  │───▶│   Control   │───▶│    Edge     │  │
│  │    Layer    │    │    Layer    │    │    Layer    │    │Infrastructure│  │
│  └─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘  │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    EC-MBR 특화 모듈 (차별화 핵심)                      │   │
│  │  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐            │   │
│  │  │ 전극 수명 예측  │  │ 동적막 형성    │  │ 전기응집-MBR  │            │   │
│  │  │   AI 모듈     │  │  최적화 모듈   │  │  통합 제어    │            │   │
│  │  └───────────────┘  └───────────────┘  └───────────────┘            │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. 4-Layer 아키텍처 상세

### Layer 1: Sensing Layer (데이터 수집층)

| 구분 | 센서 종류 | 측정 항목 | 주기 | 비고 |
|------|----------|----------|------|------|
| 수질 센서 | pH, DO, ORP, 탁도 | 실시간 수질 | 1분 | 분리막조, 방류수 |
| 전기응집 센서 | 전압, 전류, 전력량 | 전극 상태 | 10초 | EC 특화 |
| 막 상태 센서 | TMP(차압), Flux | 막 오염도 | 실시간 | MBR 핵심 |
| 공정 센서 | 수위, 유량, 온도 | 운전 상태 | 1분 | 전 공정 |
| 설비 센서 | 전류, 진동, 압력 | 펌프/블로워 | 1분 | 고장 예측 |

**차별화 포인트 - 다단 전처리 시스템:**

```
원수 → 자동역세 여과장치(300μm) → 막여과모듈 → 수질측정기
         ↓ 역세수                    ↓ 농축수
       반송조로 반송              분리막조로 반송
```

---

### Layer 2: Analytics Layer (AI 분석층)

#### 2-1. 핵심 AI 모델 구성

```
┌─────────────────────────────────────────────────────────────────┐
│                    Bi-LSTM with Attention                       │
├─────────────────────────────────────────────────────────────────┤
│  입력 그룹 A (시계열 72h)          입력 그룹 B (제어변수)          │
│  ├─ 센서 직접값 (15개)            ├─ 송풍량 설정값               │
│  ├─ 파생변수 (7개)                ├─ PAC/Polymer/NaOH 투입량     │
│  │  └─ F/M비, HRT, SRT 등        └─ 전기응집 전류밀도 ★         │
│  └─ 시간변수 (3개)                                              │
├─────────────────────────────────────────────────────────────────┤
│  출력 (6시간 선행 예측)                                          │
│  ├─ 방류수질: COD, BOD, SS, T-N, T-P                           │
│  ├─ 전극 잔여수명 (EC 특화) ★                                   │
│  └─ 막 오염 지수 (TMP 상승률 예측)                               │
└─────────────────────────────────────────────────────────────────┘
```

#### 2-2. EC-MBR 특화 예측 모델

| 모델 | 목적 | 입력 | 출력 | 독창성 |
|------|------|------|------|--------|
| 전극 수명 예측 | 전극 교체 시기 최적화 | 전압변동, 전류밀도, 운전시간 | 잔여수명(hr) | 정역 극전환 주기 자동 최적화 |
| 동적막 형성 예측 | Al(OH)₃ 동적막 두께 제어 | 전기응집 조건, TMP | 최적 동적막 상태 | EC-MBR 시너지 극대화 |
| 통합 오염 예측 | 전극+막 동시 관리 | 복합 센서 데이터 | 세정 스케줄 | 이원화 관리 → 통합 관리 |

#### 2-3. PSO 최적화 엔진 (경량화)

```python
# 목적함수 (EC-MBR 특화)
def objective_function(particle):
    # particle = [PAC, Polymer, NaOH, 송풍량, 전류밀도, 극전환주기]

    cost = (
        α₁ × 전력비용(송풍기 + 전기응집) +    # 가중치 0.5
        α₂ × 약품비용(PAC + Polymer + NaOH) + # 가중치 0.2
        α₃ × 전극소모비용(전류밀도 기반) +      # 가중치 0.2 ★ EC특화
        α₄ × 수질위반_페널티                   # 가중치 0.1
    )
    return cost

# 경량화 설정 (엣지 최적화)
n_particles = 20    # 입자 수
n_iterations = 15   # 세대 수
early_stop = 3      # 조기 종료 조건
```

---

### Layer 3: Control Layer (제어층)

#### 3-1. 하이브리드 제어 전략

```
                    ┌─────────────────────────────────┐
                    │     AI Feed-forward (90%)       │
                    │   6시간 선행 예측 기반 제어        │
                    └─────────────┬───────────────────┘
                                  │
    ┌─────────────────────────────┼─────────────────────────────┐
    │                             ▼                             │
    │  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐   │
    │  │  전기응집    │    │    MBR     │    │   약품투입   │   │
    │  │  제어모듈    │    │  제어모듈   │    │   제어모듈   │   │
    │  └─────────────┘    └─────────────┘    └─────────────┘   │
    │         │                   │                   │         │
    └─────────┼───────────────────┼───────────────────┼─────────┘
              │                   │                   │
              ▼                   ▼                   ▼
    ┌─────────────────────────────────────────────────────────┐
    │              실시간 Feedback 보정 (10%)                   │
    │         |실측 - 예측| > 20% 시 가중치 증가                │
    └─────────────────────────────────────────────────────────┘
```

#### 3-2. EC-MBR 통합 제어 로직

```
[전기응집 제어]
IF 유입 COD 예측 > 150 mg/L (고부하):
    전류밀도: 기본 × 1.3
    극전환 주기: 30분 → 20분 (오염 방지 강화)

IF 전압 변동율 > 30%:
    초음파 세정 트리거
    극전환 즉시 실행

[MBR 연동 제어]
IF TMP 상승률 > 2 kPa/hr:
    전기응집 강화 (동적막 보강)
    Flux 목표: 0.324 → 0.28 m³/m²·day (부하 경감)

IF 동적막 두께 과다 (TMP > 40 kPa):
    전기응집 일시 중단
    주간세정 실행
```

#### 3-3. Safety Layer (6층 검증)

| 층 | 검증 항목 | 조치 |
|---|----------|------|
| 1 | 물리적 제약 (펌프 용량, 전극 한계) | 명령 클리핑 |
| 2 | 예측 신뢰도 (Uncertainty > 0.3) | 보수적 제어 |
| 3 | 법적 기준 (방류수질 80% 도달) | 긴급 제어 |
| 4 | 센서 이상 (복수 센서 동시 이상) | 수동 모드 |
| 5 | **전극 보호** (전압 급상승) | EC 정지 ★ |
| 6 | **막 보호** (TMP > 50 kPa) | 흡입펌프 정지 |

---

### Layer 4: Edge Infrastructure (3-Tier 하이브리드 아키텍처)

> 3-Tier 전체 구조도는 [README.md](README.md)를 참조하세요.

#### 4-1. 아키텍처 결정 근거

AI 추론을 **Tier 2 (Gateway)**에서 수행:
- 데이터 흐름: Tier 1 수집 → Tier 2 InfluxDB 저장 → AI 추론 → Tier 3 제어
- Tier 2 집중화로 모델 관리, 디버깅, 업데이트 용이
- Tier 1 비용 절감 (Hailo NPU 불필요, ~$100 절약)
- Fallback: 네트워크 단절 시 Tier 1에서 Rule-based로 Tier 3 직접 제어

#### 4-2. Tier별 역할

| Tier | 하드웨어 | 주요 역할 | 비용 |
|------|---------|----------|------|
| **Tier 1** | RPi 5 (4GB) | 센서 수집, QA/QC, 로컬 캐시, Fallback 제어 | ~$150 |
| **Tier 2** | Mini PC + Hailo-8L | **AI 추론**, PSO 최적화, DB, Dashboard | ~$300 |
| **Tier 3** | ESP32 + 릴레이 + Safety PLC | 액추에이터 제어 (무인자동/반자동/수동) | ~$100 |

#### 4-3. AI 모델 최적화 (Tier 2 배포)

| 단계 | 변환 | 결과 |
|------|------|------|
| 1 | TensorFlow → ONNX | 호환성 확보 |
| 2 | ONNX → Hailo HEF | NPU 최적화 |
| 3 | INT8 양자화 | 모델 73% 경량화 |
| 최종 | 추론 시간 | 1.2초 (목표 2초 이내) |

---

## 3. EC-MBR 특화 차별화 기술

| 기술 | 기존 MBR | EC-MBR AI (제안) | 효과 |
|------|----------|------------------|------|
| 전극 관리 | 수동 점검 | AI 수명 예측 + 자동 극전환 | 전압 변동율 30%↓ |
| 동적막 활용 | 미적용 | Al(OH)₃ 동적막 두께 AI 제어 | Flux 8%↑, 막오염 완화 |
| 통합 최적화 | 개별 제어 | 전기응집+MBR PSO 통합 최적화 | 전력비 10%↓ |
| 선제적 제어 | 사후 Feedback | 6시간 선행 Feed-forward | 수질 위반 0회 |

---

## 4. 한국 환경법령 준수 설계

| 법령 | 기준 | 시스템 적용 |
|------|------|-------------|
| 물환경보전법 시행규칙 | COD ≤ 40, BOD ≤ 10, SS ≤ 10 mg/L | Safety Layer 80% 경고 |
| 수질TMS 운영규정 | 실시간 모니터링 | 1분 주기 데이터 수집 |
| 하수도법 | 방류수질 기준 | 3-Tier 검증 체계 |

---

## 5. 개발 우선순위 제안

| 순위 | 모듈 | 이유 |
|------|------|------|
| 1 | 전극 수명 예측 AI | EC-MBR 핵심 차별화, 운영비 절감 직결 |
| 2 | 동적막 형성 최적화 | Flux 향상 목표(8%) 달성 핵심 |
| 3 | 통합 PSO 엔진 | 전력비 10% 절감 목표 달성 |
| 4 | Safety Layer | 수질 기준 0회 초과 보장 |

> 이 아키텍처에 대해 수정이 필요한 부분이나 추가로 상세화할 영역이 있으시면 말씀해 주세요. 특히 전극 수명 예측 AI 모델이나 동적막 최적화 알고리즘 등 특정 모듈에 대한 상세 설계도 진행할 수 있습니다.

---

## 6. AI Feed-forward 6시간 선행 예측 기반 제어 아키텍처

> **Q:** AI Feed-forward 6시간 선행 예측 기반 제어의 코드가 어떻게 구현될 수 있나요? 아키텍처 방식으로 이해할 수 있도록 설명해주세요.

사용자가 AI Feed-forward 6시간 선행 예측 기반 제어의 코드 구현 방식을 아키텍처 관점에서 이해할 수 있도록 설명해달라고 요청했습니다.

이 부분은 EC-MBR 시스템에서 핵심적인 부분으로, 기존의 Feedback 제어(사후 대응)와 달리 미래를 예측하여 선제적으로 대응하는 Feed-forward 제어 방식입니다.

다음과 같은 구조로 설명합니다:

1. 기존 Feedback vs Feed-forward 비교 (개념 이해)
2. 전체 데이터 흐름 아키텍처
3. 각 단계별 상세 설명
4. 코드 구조 (의사코드 + 실제 구현 가능한 형태)
5. 실제 제어 시나리오 예시

---

### 6.1. 기존 방식 vs Feed-forward 방식 비교

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      기존 Feedback 제어 (사후 처방)                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   유입수 ──▶ [폭기조] ──▶ [분리막조] ──▶ 방류수 ──▶ 수질 측정                        │
│              (6~12시간 체류)                           │                      │
│                                                      ▼                      │
│                                              "COD 높네? 송풍량 올려!"           │
│                                                      │                      │
│                                                      ▼                      │
│                                              이미 늦음... 😰                  │
│                                              (6시간 전 유입수는 이미 방류)        │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                    Feed-forward 제어 (사전 처방) ✨                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   유입수 ──▶ AI 예측: "6시간 후 COD 높을 예정!"                                    │
│      │              │                                                       │
│      │              ▼                                                       │
│      │      지금 바로 송풍량 증가 💪                                             │
│      │              │                                                       │
│      ▼              ▼                                                       │
│   [폭기조] ──▶ [분리막조] ──▶ 방류수 ──▶ 수질 양호 ✅                               │
│   (강화된 처리)                                                                │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

### 6.2. Feed-forward 제어 전체 아키텍처

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        STEP 1: 데이터 수집                           │   │
│  │                         (매 1분마다)                                  │   │
│  └───────────────────────────────┬─────────────────────────────────────┘   │
│                                  │                                         │
│                                  ▼                                         │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                      STEP 2: 데이터 전처리                           │   │
│  │              72시간 시계열 데이터 → 정규화 → 윈도우 생성               │   │
│  └───────────────────────────────┬─────────────────────────────────────┘   │
│                                  │                                         │
│                                  ▼                                         │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    STEP 3: Bi-LSTM 예측                             │   │
│  │                   (매 5분마다 실행)                                   │   │
│  │  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐              │   │
│  │  │ 1시간 후 예측 │    │ 3시간 후 예측 │    │ 6시간 후 예측 │              │   │
│  │  │ COD: 35     │    │ COD: 42     │    │ COD: 55     │              │   │
│  │  │ 신뢰도: 95% │    │ 신뢰도: 90% │    │ 신뢰도: 85% │              │   │
│  │  └─────────────┘    └─────────────┘    └─────────────┘              │   │
│  └───────────────────────────────┬─────────────────────────────────────┘   │
│                                  │                                         │
│                                  ▼                                         │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                   STEP 4: 제어 전략 결정                             │   │
│  │          예측값 기반 → PSO 최적화 → 최적 제어 파라미터 도출             │   │
│  └───────────────────────────────┬─────────────────────────────────────┘   │
│                                  │                                         │
│                                  ▼                                         │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                   STEP 5: Safety 검증                               │   │
│  │              물리적 한계 / 법적 기준 / 센서 이상 검증                   │   │
│  └───────────────────────────────┬─────────────────────────────────────┘   │
│                                  │                                         │
│                                  ▼                                         │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                   STEP 6: PLC 명령 전송                             │   │
│  │              Modbus TCP → 펌프/블로워/약품펌프 제어                    │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

### 6.3. 각 단계별 상세 아키텍처

#### STEP 1: 데이터 수집 모듈

```
┌─────────────────────────────────────────────────────────────────┐
│                     DataCollector                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   ┌─────────────┐     ┌─────────────┐     ┌─────────────┐      │
│   │   PLC       │     │   센서들     │     │  외부 데이터  │      │
│   │ (Modbus)    │     │ (pH,DO,탁도) │     │ (날씨,시간)  │      │
│   └──────┬──────┘     └──────┬──────┘     └──────┬──────┘      │
│          │                   │                   │              │
│          └───────────────────┼───────────────────┘              │
│                              ▼                                  │
│                    ┌─────────────────┐                          │
│                    │   RawDataBuffer │                          │
│                    │   (1분 주기)     │                          │
│                    └────────┬────────┘                          │
│                             │                                   │
│                             ▼                                   │
│                    ┌─────────────────┐                          │
│                    │   InfluxDB      │                          │
│                    │  (72시간 보관)   │                          │
│                    └─────────────────┘                          │
└─────────────────────────────────────────────────────────────────┘
```

```python
# 데이터 수집 구조
class SensorData:
    """1분 주기로 수집되는 센서 데이터 구조"""

    # 수질 센서 (15개)
    pH: float              # 0~14
    DO: float              # 용존산소 (mg/L)
    ORP: float             # 산화환원전위 (mV)
    turbidity: float       # 탁도 (NTU)
    temperature: float     # 수온 (°C)
    influent_COD: float    # 유입 COD (mg/L)
    influent_BOD: float    # 유입 BOD (mg/L)
    influent_SS: float     # 유입 SS (mg/L)
    influent_TN: float     # 유입 총질소 (mg/L)
    influent_TP: float     # 유입 총인 (mg/L)
    MLSS: float            # 활성슬러지 농도 (mg/L)
    flow_rate: float       # 유량 (m³/hr)
    TMP: float             # 막간압력차 (kPa)
    EC_voltage: float      # 전기응집 전압 (V) ★
    EC_current: float      # 전기응집 전류 (A) ★

    # 파생 변수 (7개) - 실시간 계산
    FM_ratio: float        # F/M비 (유기물/미생물)
    HRT: float             # 수리학적 체류시간
    SRT: float             # 고형물 체류시간
    organic_load: float    # 유기물 부하율
    blower_rate: float     # 송풍기 가동률 (%)
    return_sludge: float   # 반송슬러지 비율 (%)
    EC_power: float        # 전기응집 전력량 (Wh) ★

    # 시간 변수 (3개)
    hour_of_day: int       # 0~23
    day_of_week: int       # 0~6
    season: int            # 1~4
```

---

#### STEP 2: 데이터 전처리 모듈

```
┌─────────────────────────────────────────────────────────────────┐
│                     DataPreprocessor                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   Raw Data (72시간 × 25개 features)                              │
│          │                                                      │
│          ▼                                                      │
│   ┌─────────────────┐                                           │
│   │  이상치 탐지     │  ← 3σ 규칙 + IQR + 물리적 범위             │
│   │  (Outlier)      │                                           │
│   └────────┬────────┘                                           │
│            │                                                    │
│            ▼                                                    │
│   ┌─────────────────┐                                           │
│   │  결측치 처리     │  ← 5분 이하: 선형보간                      │
│   │  (Missing)      │    5~30분: Cubic Spline                   │
│   └────────┬────────┘    30분+: 과거 패턴 참조                   │
│            │                                                    │
│            ▼                                                    │
│   ┌─────────────────┐                                           │
│   │  정규화         │  ← Min-Max or Z-Score                     │
│   │  (Normalize)    │                                           │
│   └────────┬────────┘                                           │
│            │                                                    │
│            ▼                                                    │
│   ┌─────────────────┐                                           │
│   │  윈도우 생성     │  ← Sliding Window (72시간)                │
│   │  (Window)       │                                           │
│   └────────┬────────┘                                           │
│            │                                                    │
│            ▼                                                    │
│   Tensor Shape: [batch, 4320, 25]                               │
│   (72시간 × 60분 = 4320 timesteps)                               │
└─────────────────────────────────────────────────────────────────┘
```

```python
# 전처리 파이프라인 구조
class DataPreprocessor:
    """
    72시간 시계열 데이터를 AI 모델 입력 형태로 변환
    """

    def process(self, raw_data: List[SensorData]) -> np.ndarray:
        """
        입력: 72시간 × 1분 = 4,320개 SensorData
        출력: [1, 4320, 25] 형태의 정규화된 텐서
        """

        # Step 2-1: 이상치 탐지 및 제거
        cleaned = self.detect_outliers(raw_data)

        # Step 2-2: 결측치 보간
        filled = self.fill_missing(cleaned)

        # Step 2-3: 정규화 (0~1 범위)
        normalized = self.normalize(filled)

        # Step 2-4: 텐서 변환
        tensor = self.to_tensor(normalized)

        return tensor  # Shape: [1, 4320, 25]
```

---

#### STEP 3: Bi-LSTM 예측 모듈

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        Bi-LSTM with Attention                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   입력: [1, 4320, 25]                                                        │
│          │                                                                  │
│          ▼                                                                  │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                     Bi-LSTM Layer 1                                 │   │
│   │                     (128 units, dropout 0.3)                        │   │
│   │                                                                     │   │
│   │    ──────────────────────────────────────────────────▶              │   │
│   │    과거 ─────────────────────────────────────────▶ 현재              │   │
│   │                                                                     │   │
│   │    ◀──────────────────────────────────────────────────              │   │
│   │    과거 ◀───────────────────────────────────────── 현재              │   │
│   │                                                                     │   │
│   │    "과거 패턴"과 "미래로 향하는 추세" 동시 학습                         │   │
│   └───────────────────────────────┬─────────────────────────────────────┘   │
│                                   │                                         │
│                                   ▼                                         │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                     Bi-LSTM Layer 2                                 │   │
│   │                     (64 units, dropout 0.3)                         │   │
│   └───────────────────────────────┬─────────────────────────────────────┘   │
│                                   │                                         │
│                                   ▼                                         │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                     Self-Attention Layer                            │   │
│   │                                                                     │   │
│   │   "어떤 시점의 데이터가 예측에 중요한가?"                              │   │
│   │                                                                     │   │
│   │   예시:                                                              │   │
│   │   ┌────┬────┬────┬────┬────┬────┬────┬────┐                        │   │
│   │   │ 0.1│ 0.1│ 0.2│ 0.8│ 0.3│ 0.1│ 0.1│ 0.1│  ← Attention Weights  │   │
│   │   └────┴────┴────┴─▲──┴────┴────┴────┴────┘                        │   │
│   │                    │                                                │   │
│   │              "이 시점(공장 가동)이                                    │   │
│   │               6시간 후 수질에 가장 영향"                               │   │
│   └───────────────────────────────┬─────────────────────────────────────┘   │
│                                   │                                         │
│                                   ▼                                         │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                     Dense Layer (64 units)                          │   │
│   │                     + Control Variables 융합                         │   │
│   │                                                                     │   │
│   │   시계열 특징 ──┬──▶ [Concatenate] ──▶ 최종 예측                      │   │
│   │                │                                                    │   │
│   │   제어 변수 ────┘   (송풍량, 약품량, 전류밀도)                         │   │
│   └───────────────────────────────┬─────────────────────────────────────┘   │
│                                   │                                         │
│                                   ▼                                         │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                        Output Layer                                 │   │
│   │                                                                     │   │
│   │   출력 (5개 수질 지표 × 3개 시점):                                     │   │
│   │                                                                     │   │
│   │   ┌─────────────────────────────────────────────────────┐           │   │
│   │   │         │ 1시간 후 │ 3시간 후 │ 6시간 후 │           │           │   │
│   │   │─────────┼─────────┼─────────┼─────────┤           │           │   │
│   │   │ COD     │   35    │   42    │   55    │ mg/L      │           │   │
│   │   │ BOD     │    8    │    9    │   12    │ mg/L      │           │   │
│   │   │ SS      │    6    │    7    │    9    │ mg/L      │           │   │
│   │   │ T-N     │   15    │   16    │   18    │ mg/L      │           │   │
│   │   │ T-P     │  1.2    │  1.4    │  1.8    │ mg/L      │           │   │
│   │   └─────────────────────────────────────────────────────┘           │   │
│   │                                                                     │   │
│   │   + 신뢰도 (Uncertainty): [0.95, 0.90, 0.85]                         │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

```python
# Bi-LSTM 모델 구조 (의사 코드)
class BiLSTMPredictor:
    """
    6시간 선행 수질 예측 모델
    """

    def __init__(self):
        self.model = self._build_model()

    def _build_model(self):
        """
        모델 아키텍처 정의
        """
        # 입력 1: 시계열 데이터 [batch, 4320, 25]
        time_series_input = Input(shape=(4320, 25))

        # 입력 2: 제어 변수 [batch, 4]
        control_input = Input(shape=(4,))

        # Bi-LSTM Layer 1
        x = Bidirectional(LSTM(128, return_sequences=True, dropout=0.3))(time_series_input)

        # Bi-LSTM Layer 2
        x = Bidirectional(LSTM(64, return_sequences=True, dropout=0.3))(x)

        # Self-Attention
        attention_weights = self._attention_layer(x)
        context = attention_weights * x
        context = GlobalAveragePooling1D()(context)

        # 제어 변수 융합
        combined = Concatenate()([context, control_input])

        # Dense Layers
        x = Dense(64, activation='relu')(combined)
        x = Dropout(0.3)(x)

        # 출력: 5개 수질 × 3개 시점 = 15개
        output = Dense(15, activation='linear')(x)

        return Model(inputs=[time_series_input, control_input], outputs=output)

    def predict(self, sensor_data: np.ndarray, control_vars: np.ndarray) -> PredictionResult:
        """
        예측 실행

        Args:
            sensor_data: [1, 4320, 25] 형태의 시계열
            control_vars: [1, 4] 형태의 제어변수 (송풍량, PAC, Polymer, 전류밀도)

        Returns:
            PredictionResult: 1h/3h/6h 후 예측값 + 신뢰도
        """
        raw_output = self.model.predict([sensor_data, control_vars])

        # 출력 reshape: [15] → [3시점, 5수질]
        predictions = raw_output.reshape(3, 5)

        # 신뢰도 계산 (Monte Carlo Dropout)
        uncertainty = self._calculate_uncertainty(sensor_data, control_vars)

        return PredictionResult(
            hour_1=predictions[0],   # [COD, BOD, SS, TN, TP]
            hour_3=predictions[1],
            hour_6=predictions[2],
            confidence=[0.95, 0.90, 0.85]  # 시간이 멀수록 신뢰도 감소
        )
```

---

#### STEP 4: 제어 전략 결정 모듈

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        ControlStrategyDecider                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   예측 결과 입력                                                              │
│   ┌─────────────────────────────────────────┐                               │
│   │  6시간 후 예측: COD=55, BOD=12, SS=9    │                               │
│   │  법적 기준: COD≤40, BOD≤10, SS≤10      │                               │
│   │  → COD, BOD 초과 위험! ⚠️               │                               │
│   └───────────────────┬─────────────────────┘                               │
│                       │                                                     │
│                       ▼                                                     │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                    부하 상태 판단                                     │   │
│   │                                                                     │   │
│   │   IF 예측 COD > 법적기준 × 0.8 (32 mg/L):                            │   │
│   │       → "고부하" 상태                                                │   │
│   │                                                                     │   │
│   │   ELIF 예측 COD < 법적기준 × 0.5 (20 mg/L):                          │   │
│   │       → "저부하" 상태 (Eco Mode 가능)                                 │   │
│   │                                                                     │   │
│   │   ELSE:                                                             │   │
│   │       → "정상" 상태                                                  │   │
│   └───────────────────┬─────────────────────────────────────────────────┘   │
│                       │                                                     │
│                       ▼                                                     │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                    PSO 최적화 실행                                    │   │
│   │                                                                     │   │
│   │   목표: "예측 수질을 기준 이내로 유지하면서 비용 최소화"                  │   │
│   │                                                                     │   │
│   │   탐색 공간:                                                         │   │
│   │   ┌─────────────────────────────────────────────────────┐           │   │
│   │   │  송풍량      │  15 ~ 22 m³/min    │  현재: 18       │           │   │
│   │   │  PAC 투입량  │  50 ~ 200 mg/L    │  현재: 100      │           │   │
│   │   │  Polymer    │   2 ~ 10 mg/L     │  현재: 5        │           │   │
│   │   │  전류밀도    │   5 ~ 15 A/m²     │  현재: 9.4      │           │   │
│   │   │  극전환 주기 │  15 ~ 60 min      │  현재: 30       │           │   │
│   │   └─────────────────────────────────────────────────────┘           │   │
│   │                                                                     │   │
│   │   [PSO 20입자 × 15세대 → 약 45초]                                    │   │
│   │                                                                     │   │
│   │   최적 결과:                                                         │   │
│   │   ┌─────────────────────────────────────────────────────┐           │   │
│   │   │  송풍량: 22 m³/min (+22%)                           │           │   │
│   │   │  PAC: 150 mg/L (+50%)                              │           │   │
│   │   │  전류밀도: 12 A/m² (+28%)                           │           │   │
│   │   │  극전환 주기: 20 min (오염 방지 강화)                 │           │   │
│   │   │  예상 방류 COD: 38 mg/L (기준 이내 ✅)               │           │   │
│   │   │  예상 비용 증가: +8%                                │           │   │
│   │   └─────────────────────────────────────────────────────┘           │   │
│   └───────────────────┬─────────────────────────────────────────────────┘   │
│                       │                                                     │
│                       ▼                                                     │
│                 ControlCommand 생성                                         │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

```python
# 제어 전략 결정 로직
class ControlStrategyDecider:
    """
    예측 결과를 바탕으로 최적 제어 파라미터 결정
    """

    # 법적 기준 (물환경보전법)
    LEGAL_LIMITS = {
        'COD': 40,   # mg/L
        'BOD': 10,
        'SS': 10,
        'TN': 20,
        'TP': 2
    }

    def decide(self, prediction: PredictionResult, current_state: SystemState) -> ControlCommand:
        """
        예측 결과 기반 제어 명령 결정
        """

        # 1. 부하 상태 판단
        load_status = self._assess_load(prediction.hour_6)

        # 2. 부하 상태별 전략 선택
        if load_status == "HIGH_LOAD":
            strategy = HighLoadStrategy()
        elif load_status == "LOW_LOAD":
            strategy = EcoModeStrategy()
        else:
            strategy = NormalStrategy()

        # 3. PSO 최적화 실행
        optimal_params = self._run_pso_optimization(
            prediction=prediction,
            current_state=current_state,
            strategy=strategy
        )

        # 4. 제어 명령 생성
        return ControlCommand(
            blower_speed=optimal_params['blower'],
            pac_dosage=optimal_params['PAC'],
            polymer_dosage=optimal_params['Polymer'],
            naoh_dosage=optimal_params['NaOH'],
            ec_current_density=optimal_params['EC_current'],
            polarity_switch_interval=optimal_params['switch_interval']
        )

    def _assess_load(self, prediction_6h: np.ndarray) -> str:
        """부하 상태 판단"""
        predicted_COD = prediction_6h[0]

        if predicted_COD > self.LEGAL_LIMITS['COD'] * 0.8:  # 32 mg/L
            return "HIGH_LOAD"
        elif predicted_COD < self.LEGAL_LIMITS['COD'] * 0.5:  # 20 mg/L
            return "LOW_LOAD"
        else:
            return "NORMAL"

    def _run_pso_optimization(self, prediction, current_state, strategy):
        """
        PSO로 최적 제어 파라미터 탐색
        """
        def objective(particle):
            # particle = [송풍량, PAC, Polymer, NaOH, 전류밀도, 극전환주기]

            # Bi-LSTM으로 이 파라미터 적용 시 수질 예측
            simulated_quality = self.predictor.predict_with_control(
                current_state, particle
            )

            # 비용 계산
            energy_cost = self._calc_energy_cost(particle)
            chemical_cost = self._calc_chemical_cost(particle)
            electrode_cost = self._calc_electrode_cost(particle)  # EC 특화

            # 수질 위반 페널티
            violation_penalty = self._calc_violation_penalty(simulated_quality)

            # 목적함수 (최소화)
            total_cost = (
                0.5 * energy_cost +
                0.2 * chemical_cost +
                0.2 * electrode_cost +
                0.1 * violation_penalty
            )

            return total_cost

        # PSO 실행 (경량화)
        optimizer = PSO(
            n_particles=20,
            n_iterations=15,
            bounds=strategy.get_bounds()
        )

        return optimizer.optimize(objective)
```

---

#### STEP 5: Safety Layer (6층 검증)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           SafetyLayer                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   제어 명령 입력                                                               │
│          │                                                                  │
│          ▼                                                                  │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  Layer 1: 물리적 제약 검증                                              │   │
│   │  ────────────────────────────                                       │   │
│   │  • 송풍량 ≤ 22 m³/min (정격의 80%)?                                     │   │
│   │  • 전류밀도 ≤ 15 A/m² (전극 한계)?                                       │   │
│   │  • 펌프 용량 초과 여부?                                                  │   │
│   │  → 위반 시: 값 클리핑                                                   │   │
│   └───────────────────────────────┬─────────────────────────────────────┘   │
│                                   │ ✅ PASS                                 │
│                                   ▼                                         │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  Layer 2: 예측 신뢰도 검증                                              │   │
│   │  ────────────────────────────                                       │   │
│   │  • Uncertainty < 0.3?                                               │   │
│   │  → 위반 시: 보수적 제어 (안전계수 ×1.2)                                    │   │
│   └───────────────────────────────┬─────────────────────────────────────┘   │
│                                   │ ✅ PASS                                 │
│                                   ▼                                         │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  Layer 3: 법적 기준 검증                                                │   │
│   │  ────────────────────────                                            │   │
│   │  • 예상 방류 COD < 40 × 0.8 (32 mg/L)?                                 │   │
│   │  → 위반 시: 긴급 제어 (송풍량 MAX)                                        │   │
│   └───────────────────────────────┬─────────────────────────────────────┘   │
│                                   │ ✅ PASS                                 │
│                                   ▼                                         │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  Layer 4: 센서 이상 검증                                                │   │
│   │  ────────────────────────                                           │   │
│   │  • 복수 센서 동시 이상 없음?                                              │   │
│   │  → 위반 시: 수동 모드 전환                                               │   │
│   └───────────────────────────────┬─────────────────────────────────────┘   │
│                                   │ ✅ PASS                                 │
│                                   ▼                                         │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  Layer 5: 전극 보호 (EC 특화) ★                                        │   │
│   │  ────────────────────────────                                       │   │
│   │  • 전압 변동율 < 30%?                                                  │   │
│   │  • 전압 급상승 (>5V/min) 없음?                                          │   │
│   │  → 위반 시: EC 정지 + 초음파 세정 트리거                                   │   │
│   └───────────────────────────────┬─────────────────────────────────────┘   │
│                                   │ ✅ PASS                                 │
│                                   ▼                                         │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  Layer 6: 막 보호 (MBR 특화)                                           │   │
│   │  ────────────────────────────                                       │   │
│   │  • TMP < 50 kPa?                                                    │   │
│   │  • 흡입펌프 연속가동 < 7분?                                              │   │
│   │  → 위반 시: 흡입펌프 정지, 세정 트리거                                      │   │
│   └───────────────────────────────┬─────────────────────────────────────┘   │
│                                   │ ✅ PASS                                 │
│                                   ▼                                         │
│                         검증된 ControlCommand 출력                          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

```python
# Safety Layer 구현
class SafetyLayer:
    """
    6층 안전 검증 시스템
    """

    def validate(self, command: ControlCommand, system_state: SystemState) -> ValidatedCommand:
        """
        6단계 안전 검증 수행
        """

        # Layer 1: 물리적 제약
        command = self._check_physical_limits(command)

        # Layer 2: 예측 신뢰도
        command = self._check_prediction_confidence(command, system_state)

        # Layer 3: 법적 기준
        command = self._check_legal_compliance(command, system_state)

        # Layer 4: 센서 이상
        if self._check_sensor_anomaly(system_state):
            return self._fallback_to_manual()

        # Layer 5: 전극 보호 (EC 특화)
        command = self._check_electrode_protection(command, system_state)

        # Layer 6: 막 보호
        command = self._check_membrane_protection(command, system_state)

        return ValidatedCommand(command, validation_passed=True)

    def _check_electrode_protection(self, command, state):
        """
        전극 보호 로직 (EC-MBR 특화)
        """
        voltage_variance = state.ec_voltage_variance
        voltage_rate = state.ec_voltage_rate_of_change

        if voltage_variance > 0.30:  # 30% 이상 변동
            # 초음파 세정 트리거
            command.trigger_ultrasonic_cleaning = True
            # 전류밀도 감소
            command.ec_current_density *= 0.7

        if voltage_rate > 5.0:  # 5V/min 이상 급상승
            # 전기응집 일시 정지
            command.ec_emergency_stop = True

        return command
```

---

#### STEP 6: PLC 명령 전송

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          PLCController                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ValidatedCommand 입력                                                      │
│          │                                                                  │
│          ▼                                                                  │
���   ┌─────────────────────────────────────────────────────────────────────┐ │
│   │                    명령 변환 (Command Translator)                     │   │
│   │                                                                     │   │
│   │   AI 명령              →        PLC 레지스터                           │   │
│   │   ──────────────────────────────────────────────────                │   │
│   │   blower_speed: 22    →   HR_100: 22 (m³/min)                      │   │
│   │   pac_dosage: 150     →   HR_101: 150 (mg/L)                       │   │
│   │   ec_current: 12      →   HR_110: 120 (A × 10)                     │   │
│   │   switch_interval: 20 →   HR_111: 1200 (sec)                       │   │
│   │                                                                     │   │
│   └───────────────────────────────┬─────────────────────────────────────┘   │
│                                   │                                         │
│                                   ▼                                         │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                    Modbus TCP 통신                                   │   │
│   │                                                                     │   │
│   │   ┌─────────────┐                     ┌─────────────┐               │   │
│   │   │  Edge AI    │ ◀───── Modbus ────▶ │    PLC     │                │   │
│   │   │  (Client)   │      TCP/502        │  (Server)  │                │   │
│   │   └─────────────┘                     └─────────────┘               │   │
│   │                                                                     │   │
│   │   • Write Holding Registers: 제어값 전송                               │   │
│   │   • Read Input Registers: 피드백 확인                                  │   │
│   │   • Response Time: < 10ms                                           │   │
│   │                                                                     │   │
│   └───────────────────────────────┬─────────────────────────────────────┘   │
│                                   │                                         │
│                                   ▼                                         │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                    실행 확인 (Verification)                           │   │
│   │                                                                     │   │
│   │   1. Write 후 Read-back 확인                                          │   │
│   │   2. 설정값 vs 실제값 비교                                              │   │
│   │   3. |설정 - 실제| > 허용오차 → 재시도 또는 경보                            │   │
│   │                                                                     │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

```python
# PLC 통신 구현
class PLCController:
    """
    Modbus TCP를 통한 PLC 제어
    """

    def __init__(self, plc_ip: str, port: int = 502):
        self.client = ModbusTcpClient(plc_ip, port)

    def send_command(self, command: ValidatedCommand) -> ExecutionResult:
        """
        제어 명령을 PLC로 전송
        """
        try:
            # 1. 연결 확인
            if not self.client.connect():
                return ExecutionResult(success=False, error="Connection failed")

            # 2. 명령 변환 및 전송
            registers = self._command_to_registers(command)

            for addr, value in registers.items():
                self.client.write_register(addr, value)

            # 3. 실행 확인 (Read-back)
            time.sleep(0.1)  # PLC 처리 대기

            verification = self._verify_execution(registers)

            if not verification.success:
                return ExecutionResult(success=False, error="Verification failed")

            # 4. 실행 로그 기록
            self._log_execution(command, verification)

            return ExecutionResult(success=True)

        finally:
            self.client.close()

    def _command_to_registers(self, command):
        """AI 명령 → PLC 레지스터 변환"""
        return {
            100: int(command.blower_speed * 10),      # 송풍량 (0.1 단위)
            101: int(command.pac_dosage),              # PAC (mg/L)
            102: int(command.polymer_dosage * 10),     # Polymer (0.1 단위)
            103: int(command.naoh_dosage),             # NaOH (L/hr)
            110: int(command.ec_current_density * 10), # 전류밀도 (0.1 단위)
            111: int(command.polarity_switch_interval * 60),  # 극전환 (초)
        }
```

---

### 6.4. 전체 흐름 타임라인

```
시간축 ─────────────────────────────────────────────────────────────────────────▶

T=0분        T=5분        T=30분       T=60분       T=360분 (6시간 후)
  │            │            │            │              │
  │            │            │            │              │
  ▼            ▼            ▼            ▼              ▼
┌────┐      ┌────┐      ┌────┐      ┌────┐         ┌────┐
│데이터│      │예측 │      │PSO │      │모니터│         │결과│
│수집 │      │실행 │      │최적화│      │링   │         │검증│
└────┘      └────┘      └────┘      └────┘         └────┘
  │            │           │           │              │
  │  72시간     │  예측:     │  최적화된   │   실시간       │  방류수
  │  시계열     │  COD=55    │  제어값    │   조정         │  COD=38
  │  데이터     │  (6h후)     │  적용      │   (Feedback) │  ✅ 기준 이내
  │            │            │            │              │
  │            │            │            │              │
  │            ▼            ▼            │              │
  │       "고부하 예상"  송풍량 +22%         │              │
  │       "선제 조치"    PAC +50%          │              │
  │                      전류 +28%        │              │
  │                                      │              │
  │◀────────── Feed-forward 제어 ──────────────────────▶│
  │                                      │              │
  │                              │◀── Feedback 보정 ──▶│
  │                              │      (10% 비중)      │
```

---

### 6.5. 핵심 포인트 요약

| 구분 | 내용 |
|------|------|
| 예측 선행 시간 | 6시간 (생물반응조 체류시간 고려) |
| 예측 주기 | 5분마다 실행 |
| 최적화 주기 | 30분마다 (또는 부하 급변 시 즉시) |
| 제어 비중 | Feed-forward 90% + Feedback 10% |
| Safety 검증 | 6층 검증 후 PLC 전송 |
| 응답 시간 | 예측 1.2초 + 최적화 45초 + 전송 10ms |
